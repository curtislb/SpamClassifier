From beginners-return-92689-ktwarwic=speedy.uwaterloo.ca@perl.org  Sat Jun 23 03:55:18 2007
Return-Path: <beginners-return-92689-ktwarwic=speedy.uwaterloo.ca@perl.org>
Received: from lists.develooper.com (x6.develooper.com [63.251.223.186])
	by flax9.uwaterloo.ca (8.12.8/8.12.5) with SMTP id l5N7tHL9015850
	for <ktwarwic@flax9.uwaterloo.ca>; Sat, 23 Jun 2007 03:55:18 -0400
Received: (qmail 22929 invoked by uid 514); 23 Jun 2007 07:55:08 -0000
Mailing-List: contact beginners-help@perl.org; run by ezmlm
Precedence: bulk
List-Post: <mailto:beginners@perl.org>
List-Help: <mailto:beginners-help@perl.org>
List-Unsubscribe: <mailto:beginners-unsubscribe@perl.org>
List-Subscribe: <mailto:beginners-subscribe@perl.org>
List-Id: <beginners.perl.org>
Delivered-To: mailing list beginners@perl.org
Received: (qmail 22920 invoked from network); 23 Jun 2007 07:55:08 -0000
Received: from x1a.develooper.com (HELO x1.develooper.com) (216.52.237.111)
  by lists.develooper.com with SMTP; 23 Jun 2007 07:55:08 -0000
Received: (qmail 3527 invoked by uid 225); 23 Jun 2007 07:55:07 -0000
Delivered-To: beginners@perl.org
Received: (qmail 3519 invoked by alias); 23 Jun 2007 07:55:07 -0000
X-Spam-Status: No, hits=0.5 required=8.0
	tests=BAYES_00,DKIM_POLICY_SIGNSOME,DK_POLICY_SIGNSOME,DK_POLICY_TESTING,FORGED_YAHOO_RCVD,RDNS_NONE,SPF_NEUTRAL
X-Spam-Check-By: la.mx.develooper.com
Received-SPF: neutral (x1.develooper.com: local policy)
Received: from Unknown (HELO mail1.dulles.sv.int) (216.12.128.138)
    by la.mx.develooper.com (qpsmtpd/0.28) with ESMTP; Sat, 23 Jun 2007 00:55:00 -0700
Received: from [192.168.4.118] ([192.168.4.118]) by mail1.dulles.sv.int with Microsoft SMTPSVC(6.0.3790.1830);
	 Sat, 23 Jun 2007 03:54:54 -0400
Message-ID: <467CD1CF.8070300@yahoo.com>
Date: Sat, 23 Jun 2007 03:54:55 -0400
From: Mathew Snyder <theillien@yahoo.com>
User-Agent: Thunderbird 1.5.0.12 (X11/20060911)
MIME-Version: 1.0
To: Perl Beginners <beginners@perl.org>
Subject: problem with readline
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit
X-OriginalArrivalTime: 23 Jun 2007 07:54:54.0896 (UTC) FILETIME=[C96ED300:01C7B56B]

I have a script that queries a database, grabs a bunch of email addresses from
it and generates a procmail ruleset for each of them.  It also opens a file
which contains additional email address and reads them into an array:

open AUTHFILE, "</home/customercare/authorized_users.txt" or die "Can't open
file: $!";
foreach my $address (readline AUTHFILE){
    chomp($address);
    next if $address =~ m/^#/gmx;
    push @email_list, $address;
}

This seems to have worked at one point but appears to have been changed and
doesn't work anymore.  The script runs fine with the exception of the part that
opens the file and reads the addresses from it.  To be clear, it seems to open
the file.  At least, I'm not getting any errors from the "or die" part.

However, when I look for the addresses read in from the file, nothing shows up.
 Can someone help me shed some light on this?  The full script is below.

Thanks
Mathew


#!/usr/bin/perl

use strict;
use warnings;
use DBI;

my $message = "You are receiving this message in response to an email you"
    ." sent to customercare\@company.com. The email address you sent"
    ." from is not currently in our records. To have the action you"
    ." need performed, please call customer care to authenticate.";

my $dbh = DBI->connect("dbi:Pg:dbname=xx;host=10.0.2.30", "xxxxx", "xxxxxx");
my @email_list;
my $sth;
my @fields = qw/email email2 email3/;

foreach my $field (@fields){
    $sth = $dbh->prepare("
        SELECT $field
        FROM contacts");
    $sth->execute;
    while ((my $line) = $sth->fetchrow()) {
        if ($line){
            if ($line !~ /^\s+$/g){
                push @email_list, $line;
            }
        }
    }
    $sth->finish;
}


#Read in people from the authorized_users.txt file in the customercare directory
#These are email addresses that are not in OSS but are allowed to create tickets

open AUTHFILE, "</home/customercare/authorized_users.txt";
while (<AUTHFILE>) {
    chomp;
    next if $_ =~ m/^#/gmx;
    push @email_list, $_;
}

print("
#This File is generated by proclmailgen.pl and should not be edited directly.
#It will be overwritten the next time the cron job runs.

VERBOSE=off
PMDIR=\$HOME/.procmail
DEFAULT=/var/spool/mail/customercare
LOGFILE=\$PMDIR/log
LOCKFILE        # removes any preexisting lockfile
LOG=\`lockfile \$DEFAULT\$LOCKEXT\`
TRAP=\"rm -f \$DEFAULT\$LOCKEXT\"
");

printf("
:0 E
* ^From.*(customercare\@company.com)
badmail
");

printf("
:0 E
* ^Return-Path.*(customercare\@company.com)
badmail
");

printf("
:0 E
* ^X-Loop.*(customercare\@company.com)
badmail
");

for my $address (@email_list){
        $address =~ s/ //g;
        printf("
:0 E
* ^From.*(%s)
| /usr/local/rt-3.6.0/bin/rt-mailgate --queue customercare --action correspond
--url https://rt.company.com/
" , ($address));
}

printf("
:0 E
* ^From(.*)
| (formail -r -A\"X-Loop: customercare\@company.com\" ; echo \"%s\") |
/usr/sbin/sendmail -f nobounce\@company.com -t
" , ($message));

-- 
Keep up with me and what I'm up to: http://theillien.blogspot.com

-- 
To unsubscribe, e-mail: beginners-unsubscribe@perl.org
For additional commands, e-mail: beginners-help@perl.org
http://learn.perl.org/


