From samba-cvs-bounces+ktwarwic=speedy.uwaterloo.ca@lists.samba.org  Sun Apr 22 19:37:10 2007
Return-Path: <samba-cvs-bounces+ktwarwic=speedy.uwaterloo.ca@lists.samba.org>
Received: from lists.samba.org (mail.samba.org [66.70.73.150])
	by speedy.uwaterloo.ca (8.12.8/8.12.5) with ESMTP id l3MNb90I025333
	for <ktwarwic@speedy.uwaterloo.ca>; Sun, 22 Apr 2007 19:37:09 -0400
Received: from dp.samba.org (localhost [127.0.0.1])
	by lists.samba.org (Postfix) with ESMTP id 6CAC4162BC4
	for <ktwarwic@speedy.uwaterloo.ca>; Sun, 22 Apr 2007 23:36:44 +0000 (GMT)
X-Spam-Checker-Version: SpamAssassin 3.1.7 (2006-10-05) on dp.samba.org
X-Spam-Level: 
X-Spam-Status: No, score=0.4 required=3.8 tests=AWL,BAYES_05,
	DATE_IN_PAST_06_12,FORGED_RCVD_HELO,RCVD_IN_DSBL,UPPERCASE_25_50 
	autolearn=no version=3.1.7
X-Original-To: samba-cvs@samba.org
Delivered-To: samba-cvs@samba.org
Received: from smtp-vbr12.xs4all.nl (smtp-vbr12.xs4all.nl [194.109.24.32])
	by lists.samba.org (Postfix) with ESMTP id DD619162AEB
	for <samba-cvs@samba.org>; Sun, 22 Apr 2007 23:36:02 +0000 (GMT)
Received: from rhonwyn.vernstok.nl (a62-251-123-16.adsl.xs4all.nl
	[62.251.123.16])
	by smtp-vbr12.xs4all.nl (8.13.8/8.13.8) with ESMTP id l3MNa1tc044570
	for <samba-cvs@samba.org>; Mon, 23 Apr 2007 01:36:02 +0200 (CEST)
	(envelope-from jelmer@vernstok.nl)
Received: from localhost (localhost [127.0.0.1])
	by rhonwyn.vernstok.nl (Postfix) with ESMTP id 7309D39A5A8
	for <samba-cvs@samba.org>; Mon, 23 Apr 2007 01:36:01 +0200 (CEST)
X-Virus-Scanned: by XS4ALL Virus Scanner
Received: from rhonwyn.vernstok.nl ([127.0.0.1])
	by localhost (rhonwyn.vernstok.nl [127.0.0.1]) (amavisd-new, port 10024)
	with SMTP id FI4d8gtf94tg for <samba-cvs@samba.org>;
	Mon, 23 Apr 2007 01:31:57 +0200 (CEST)
Received: from ganieda.vernstok.nl (localhost [127.0.0.1])
	by rhonwyn.vernstok.nl (Postfix) with ESMTP id 5539539A5A6
	for <samba-cvs@samba.org>; Mon, 23 Apr 2007 01:28:10 +0200 (CEST)
Received: by ganieda.vernstok.nl (Postfix, from userid 1000)
	id 98C055C41B4; Sun, 22 Apr 2007 16:48:17 +0200 (CEST)
To: samba-cvs@samba.org
From: Jelmer Vernooij <jelmer@samba.org>
Message-Id: <20070422144817.98C055C41B4@ganieda.vernstok.nl>
Date: Sun, 22 Apr 2007 16:48:17 +0200 (CEST)
Subject: Rev 11978: Merge upstream in
	file:///home/jelmer/bzr.samba/SAMBA_4_0/
X-BeenThere: samba-cvs@lists.samba.org
X-Mailman-Version: 2.1.5
Precedence: list
Reply-To: samba-technical@lists.samba.org
List-Id: Samba CVS and subversion commit messages <samba-cvs.lists.samba.org>
List-Unsubscribe: <https://lists.samba.org/mailman/listinfo/samba-cvs>,
	<mailto:samba-cvs-request@lists.samba.org?subject=unsubscribe>
List-Archive: <http://lists.samba.org/archive/samba-cvs>
List-Post: <mailto:samba-cvs@lists.samba.org>
List-Help: <mailto:samba-cvs-request@lists.samba.org?subject=help>
List-Subscribe: <https://lists.samba.org/mailman/listinfo/samba-cvs>,
	<mailto:samba-cvs-request@lists.samba.org?subject=subscribe>
Sender: samba-cvs-bounces+ktwarwic=speedy.uwaterloo.ca@lists.samba.org
Errors-To: samba-cvs-bounces+ktwarwic=speedy.uwaterloo.ca@lists.samba.org
Status: O
Content-Length: 11727
Lines: 299

At file:///home/jelmer/bzr.samba/SAMBA_4_0/

------------------------------------------------------------
revno: 11978
revision-id: jelmer@samba.org-20070422144758-6tv2j8v9d801i8wi
parent: jelmer@samba.org-20070422144538-3ykcd0nnz71zguiu
parent: svn-v2:22455@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0
committer: Jelmer Vernooij <jelmer@samba.org>
branch nick: SAMBA_4_0
timestamp: Sun 2007-04-22 16:47:58 +0200
message:
  Merge upstream
modified:
  source/build/smb_build/input.pm svn-v2:3690@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fbuild%2fsmb_build%2finput.pm
  source/build/smb_build/output.pm svn-v2:3690@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fbuild%2fsmb_build%2foutput.pm
  source/heimdal_build/asn1_deps.pl svn-v2:8985@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fheimdal_build%2fasn1_deps.pl
  source/heimdal_build/config.mk svn-v2:7322@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0-source%2fheimdal_build%2fconfig.mk
    ------------------------------------------------------------
    revno: 11975.1.2
    merged: svn-v2:22455@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0
    parent: svn-v2:22454@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0
    committer: metze
    timestamp: Sun 2007-04-22 11:40:11 +0000
    message:
      split dependecies array for compiling and linking and use better names:-)
      
      calculate the CFLAGS only based on the public dependencies when recursing
      
      metze 
    ------------------------------------------------------------
    revno: 11975.1.1
    merged: svn-v2:22454@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0
    parent: svn-v2:22453@0c0555d6-39d7-0310-84fc-f1cc0bd64818-branches%2fSAMBA_4_0
    committer: metze
    timestamp: Sun 2007-04-22 11:28:12 +0000
    message:
      - let asn1_deps.pl calculate the dependencies depending on the IMPORT line in the asn1 file
      - fix some heimdal dependencies
      
      metze
=== modified file 'source/build/smb_build/input.pm'
--- a/source/build/smb_build/input.pm	2006-11-06 20:17:25 +0000
+++ b/source/build/smb_build/input.pm	2007-04-22 11:40:11 +0000
@@ -162,10 +162,10 @@
 	}
 }
 
-sub calc_unique_deps($$$$$$)
+sub calc_unique_deps($$$$$$$$)
 {
-	sub calc_unique_deps($$$$$$);
-	my ($name, $INPUT, $deps, $udeps, $withlibs, $busy) = @_;
+	sub calc_unique_deps($$$$$$$$);
+	my ($name, $INPUT, $deps, $udeps, $withlibs, $forward, $pubonly, $busy) = @_;
 
 	foreach my $n (@$deps) {
 		die("Dependency unknown: $n") unless (defined($INPUT->{$n}));
@@ -173,17 +173,19 @@
 		next if (grep /^$n$/, @$udeps);
 		my $dep = $INPUT->{$n};
 
+		push (@{$udeps}, $dep->{NAME}) if $forward;
+
  		if (defined ($dep->{OUTPUT_TYPE}) && 
 			($withlibs or 
 			(@{$dep->{OUTPUT_TYPE}}[0] eq "INTEGRATED") or 
 			(@{$dep->{OUTPUT_TYPE}}[0] eq "STATIC_LIBRARY"))) {
 				push (@$busy, $dep->{NAME});
-			        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PUBLIC_DEPENDENCIES}, $udeps, $withlibs, $busy);
-			        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PRIVATE_DEPENDENCIES}, $udeps, $withlibs, $busy);
+			        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PUBLIC_DEPENDENCIES}, $udeps, $withlibs, $forward, $pubonly, $busy);
+			        calc_unique_deps($dep->{NAME}, $INPUT, $dep->{PRIVATE_DEPENDENCIES}, $udeps, $withlibs, $forward, $pubonly, $busy) unless $pubonly;
 				pop (@$busy);
 	        }
 
-		unshift (@{$udeps}, $dep->{NAME});
+		unshift (@{$udeps}, $dep->{NAME}) unless $forward;
 	}
 }
 
@@ -242,15 +244,21 @@
 	}
 
 	foreach my $part (values %$INPUT) {
-		$part->{UNIQUE_DEPENDENCIES} = [];
-		calc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES}, 0, []);
-		calc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES}, 0, []);
+		$part->{UNIQUE_DEPENDENCIES_LINK} = [];
+		calc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_LINK}, 0, 0, 0, []);
+		calc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_LINK}, 0, 0, 0, []);
+	}
+
+	foreach my $part (values %$INPUT) {
+		$part->{UNIQUE_DEPENDENCIES_COMPILE} = [];
+		calc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_COMPILE}, 1, 1, 1, []);
+		calc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_COMPILE}, 1, 1, 1, []);
 	}
 
 	foreach my $part (values %$INPUT) {
 		$part->{UNIQUE_DEPENDENCIES_ALL} = [];
-		calc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, []);
-		calc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, []);
+		calc_unique_deps($part->{NAME}, $INPUT, $part->{PUBLIC_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, 0, 0, []);
+		calc_unique_deps($part->{NAME}, $INPUT, $part->{PRIVATE_DEPENDENCIES}, $part->{UNIQUE_DEPENDENCIES_ALL}, 1, 0, 0, []);
 	}
 
 	return $INPUT;

=== modified file 'source/build/smb_build/output.pm'
--- a/source/build/smb_build/output.pm	2007-04-02 17:14:43 +0000
+++ b/source/build/smb_build/output.pm	2007-04-22 11:40:11 +0000
@@ -148,7 +148,7 @@
 		merge_array(\$part->{FINAL_CFLAGS}, $part->{CPPFLAGS});
 		merge_array(\$part->{FINAL_CFLAGS}, $part->{CFLAGS});
 
-		foreach (reverse @{$part->{UNIQUE_DEPENDENCIES_ALL}}) {
+		foreach (@{$part->{UNIQUE_DEPENDENCIES_COMPILE}}) {
 			my $elem = $depend->{$_};
 			next if $elem == $part;
 
@@ -157,7 +157,7 @@
 		}
 
 		# Always import the link options of the unique dependencies
-		foreach (@{$part->{UNIQUE_DEPENDENCIES}}) {
+		foreach (@{$part->{UNIQUE_DEPENDENCIES_LINK}}) {
 			my $elem = $depend->{$_};
 			next if $elem == $part;
 

=== modified file 'source/heimdal_build/asn1_deps.pl'
--- a/source/heimdal_build/asn1_deps.pl	2007-04-21 23:12:45 +0000
+++ b/source/heimdal_build/asn1_deps.pl	2007-04-22 11:28:12 +0000
@@ -1,6 +1,7 @@
 #!/usr/bin/perl
 # Generate make dependency rules for asn1 files
 # Jelmer Vernooij <jelmer@samba.org> 2005
+# Stefan Metzmacher <metze@samba.org> 2007
 # GPL
 
 use File::Basename;
@@ -15,6 +16,10 @@
 my @c_files = ();
 my $o_file;
 my @o_files = ();
+my $import;
+my @imports = ();
+my $dep;
+my @deps = ();
 
 $basename = basename($file);
 if (not defined $options) {
@@ -28,8 +33,10 @@
 print "\t\@\$(builddir)/heimdal_build/asn1_compile_wrapper.sh \$(srcdir) \$(builddir) $dirname bin/asn1_compile $file $prefix $options\n\n";
 
 open(IN,$file) or die("Can't open $file: $!");
-foreach(<IN>) {
-	if (/^([\w]+[\w\-]+)(\s+OBJECT IDENTIFIER)?\s*::=/) {
+my @lines = <IN>;
+close(IN);
+foreach my $line (@lines) {
+	if ($line =~ /^([\w]+[\w\-]+)(\s+OBJECT IDENTIFIER)?\s*::=/) {
 		my $output = $1;
 		$output =~ s/-/_/g;
 		$c_file = "$dirname/asn1_$output.c";
@@ -41,9 +48,41 @@
 		push @x_files, $x_file;
 		push @c_files, $c_file;
 		push @o_files, $o_file;
-	}
-}
-close(IN);
+	} elsif ($line =~ /^(\s*IMPORT)([\w\,\s])*(\s+FROM\s+)([\w]+[\w\-]+);/) {
+		$import = $line;
+		chomp $import;
+		push @imports, $import;
+		$import = undef;
+	} elsif ($line =~ /^(\s*IMPORT).*/) {
+		$import = $line;
+		chomp $import;
+	} elsif (defined($import) and ($line =~ /;/)) {
+		$import .= $line;
+		chomp $import;
+		push @imports, $import;
+		$import = undef;
+	} elsif (defined($import)) {
+		$import .= $line;
+		chomp $import;
+	}
+}
+
+foreach $import (@imports) {
+	next unless ($import =~ /^(\s*IMPORT)([\w\,\s])*(\s+FROM\s+)([\w]+[\w\-]+);/);
+
+	my @froms = split (/\s+FROM\s+/, $import);
+	foreach my $from (@froms) {
+		next if ($from =~ /^(\s*IMPORT).*/);
+		if ($from =~ /^(\w+)/) {
+			my $f = $1;
+			$dep = 'HEIMDAL_'.uc($f).'_ASN1';
+			push @deps, $dep;
+		}
+	}
+}
+
+unshift @deps, "HEIMDAL_HEIM_ASN1" unless grep /HEIMDAL_HEIM_ASN1/, @deps;
+my $depstr = join(' ', @deps);
 
 print '[SUBSYSTEM::HEIMDAL_'.uc($prefix).']'."\n";
 print "CFLAGS = -Iheimdal_build -Iheimdal/lib/roken -I$dirname\n";
@@ -51,7 +90,7 @@
 foreach $o_file (@o_files) {
     print "\\\n\t$o_file";
 }
-print "\nPRIVATE_DEPENDENCIES = HEIMDAL_ASN1\n\n";
+print "\nPUBLIC_DEPENDENCIES = $depstr\n\n";
 
 print "clean:: \n";
 print "\t\@echo \"Deleting ASN1 output files generated from $file\"\n";

=== modified file 'source/heimdal_build/config.mk'
--- a/source/heimdal_build/config.mk	2007-04-22 00:21:14 +0000
+++ b/source/heimdal_build/config.mk	2007-04-22 11:28:12 +0000
@@ -17,7 +17,8 @@
 	../heimdal/kdc/windc.o \
 	../heimdal/kdc/kx509.o \
 	../heimdal/lib/asn1/asn1_KRB5SignedPath.o
-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5 HEIMDAL_HDB HEIMDAL_ASN1 HEIMDAL_DES HEIMDAL_DIGEST_ASN1 HEIMDAL_KX509_ASN1 HEIMDAL_NTLM
+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5 HEIMDAL_HDB HEIMDAL_HEIM_ASN1 HEIMDAL_DIGEST_ASN1 HEIMDAL_KX509_ASN1
+PUBLIC_DEPENDENCIES = HEIMDAL_NTLM HEIMDAL_DES
 # End SUBSYSTEM HEIMDAL_KDC
 #######################
 
@@ -47,14 +48,14 @@
 	../heimdal/lib/hdb/mkey.o \
 	../heimdal/lib/hdb/ndbm.o \
 	../heimdal/lib/hdb/hdb_err.o
-PRIVATE_DEPENDENCIES = HDB_LDB HEIMDAL_HDB_KEYS HEIMDAL_ROKEN HEIMDAL_HDB_ASN1
+PRIVATE_DEPENDENCIES = HDB_LDB HEIMDAL_KRB5 HEIMDAL_HDB_KEYS HEIMDAL_ROKEN HEIMDAL_DES HEIMDAL_COM_ERR HEIMDAL_HDB_ASN1
 # End SUBSYSTEM HEIMDAL_HDB
 #######################
 
 #######################
 # Start SUBSYSTEM HEIMDAL_GSSAPI
 [SUBSYSTEM::HEIMDAL_GSSAPI]
-CFLAGS = -Iheimdal_build -Iheimdal/lib/gssapi/gssapi -Iheimdal/lib/gssapi/spnego -Iheimdal/lib/gssapi/krb5 -Iheimdal/lib/gssapi/mech
+CFLAGS = -Iheimdal_build -Iheimdal/lib/gssapi -Iheimdal/lib/gssapi/gssapi -Iheimdal/lib/gssapi/spnego -Iheimdal/lib/gssapi/krb5 -Iheimdal/lib/gssapi/mech
 OBJ_FILES = \
 	../heimdal/lib/gssapi/mech/gss_krb5.o \
 	../heimdal/lib/gssapi/mech/gss_mech_switch.o \
@@ -163,7 +164,7 @@
 	../heimdal/lib/gssapi/krb5/accept_sec_context.o \
 	../heimdal/lib/gssapi/krb5/set_sec_context_option.o \
 	../heimdal/lib/gssapi/krb5/process_context_token.o
-PRIVATE_DEPENDENCIES = HEIMDAL_DES HEIMDAL_ASN1 HEIMDAL_SPNEGO_ASN1
+PRIVATE_DEPENDENCIES = HEIMDAL_DES HEIMDAL_HEIM_ASN1 HEIMDAL_SPNEGO_ASN1
 PUBLIC_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_KRB5
 # End SUBSYSTEM HEIMDAL_GSSAPI
 #######################
@@ -172,8 +173,8 @@
 # Start SUBSYSTEM HEIMDAL_KRB5
 [SUBSYSTEM::HEIMDAL_KRB5]
 CFLAGS = -Iheimdal_build -Iheimdal/lib/krb5 
-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_DES HEIMDAL_PKINIT_ASN1
-PUBLIC_DEPENDENCIES = HEIMDAL_KRB5_ASN1 HEIMDAL_GLUE HEIMDAL_HX509
+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_PKINIT_ASN1
+PUBLIC_DEPENDENCIES = HEIMDAL_KRB5_ASN1 HEIMDAL_GLUE HEIMDAL_HX509 HEIMDAL_DES
 OBJ_FILES = \
 	../heimdal/lib/krb5/acache.o \
 	../heimdal/lib/krb5/add_et_list.o \
@@ -264,8 +265,8 @@
 #######################
 
 #######################
-# Start SUBSYSTEM HEIMDAL_ASN1
-[SUBSYSTEM::HEIMDAL_ASN1]
+# Start SUBSYSTEM HEIMDAL_HEIM_ASN1
+[SUBSYSTEM::HEIMDAL_HEIM_ASN1]
 CFLAGS = -Iheimdal_build -Iheimdal/lib/asn1
 OBJ_FILES = \
 	../heimdal/lib/asn1/der_get.o \
@@ -297,7 +298,7 @@
 
 [SUBSYSTEM::HEIMDAL_DES]
 CFLAGS = -Iheimdal_build -Iheimdal/lib/des 
-PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_ASN1 HEIMDAL_DES_IMATH HEIMDAL_RFC2459_ASN1
+PRIVATE_DEPENDENCIES = HEIMDAL_ROKEN HEIMDAL_HEIM_ASN1 HEIMDAL_DES_IMATH HEIMDAL_RFC2459_ASN1
 OBJ_FILES = \
 	../heimdal/lib/des/aes.o \
 	../heimdal/lib/des/bn.o \
@@ -333,7 +334,7 @@
 CFLAGS = -Iheimdal_build -Iheimdal/lib/hx509 
 PRIVATE_DEPENDENCIES = \
 	HEIMDAL_ROKEN HEIMDAL_COM_ERR \
-	HEIMDAL_ASN1 HEIMDAL_DES \
+	HEIMDAL_HEIM_ASN1 HEIMDAL_DES \
 	HEIMDAL_CMS_ASN1 HEIMDAL_RFC2459_ASN1 \
 	HEIMDAL_OCSP_ASN1 HEIMDAL_PKCS8_ASN1 \
 	HEIMDAL_PKCS9_ASN1 HEIMDAL_PKCS12_ASN1

